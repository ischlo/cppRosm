<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Extracting road networks • cppRosm</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Extracting road networks">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">cppRosm</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/data_schema.html">An opinionated way of working with OSM data</a></li>
    <li><a class="dropdown-item" href="../articles/road_networks.html">Extracting road networks</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/ischlo/cppRosm/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Extracting road networks</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/ischlo/cppRosm/blob/main/vignettes/road_networks.Rmd" class="external-link"><code>vignettes/road_networks.Rmd</code></a></small>
      <div class="d-none name"><code>road_networks.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="description">Description<a class="anchor" aria-label="anchor" href="#description"></a>
</h2>
<p>This mini-package provides a very fast, yet user-friendly way of
exporting large road network data in a graph-like format. It uses the <a href="https://osmcode.org/libosmium/index.html" class="external-link"><strong>libosmium</strong></a>
library in the background and proposes a simple R function to extract
the road graph from a <code>.osm</code>, <code>.osm.pbf</code> extract
file with OSM data.</p>
<div class="section level3">
<h3 id="background">Background<a class="anchor" aria-label="anchor" href="#background"></a>
</h3>
<p>While there are already great packages for working with OSM data, I
found myself struggling when the networks were getting big (region,
country scale…). Usually, one would have to use command line tools and
export data to a database before actually being able to use it.
Additionally, for certain use cases, the geometry and most of the tags
associated to an OSM feature are not essential, and therefore including
them into files ultimately comes at a great cost. So this package solves
one specific use case of building a graph out of OSM road network data
with almost no size limit.</p>
<p>While the graph files produced can be used in any workflow, the
intended use case is with the <a href="https://github.com/vlarmet/cppRouting" class="external-link"><strong>cppRouting</strong></a>
package, which is outstanding for working with large scale road networks
right from your R environment. Additionally, pre-processing of raw
extract files can done with the <code>rosmium</code> package. For
example to select a more specific bounding box in your data. One
condition here is required, is that you export features in a complete
way. Missing nodes can cause problems in the current version of the
package.</p>
</div>
</div>
<div class="section level2">
<h2 id="cpprosm">cppRosm<a class="anchor" aria-label="anchor" href="#cpprosm"></a>
</h2>
<p>The function <code>extract_graph</code> accepts the path to a raw OSM
extract file, and writes into the working directory of the project 2
data sets: nodes.csv, road_segments.csv.</p>
<div class="section level3">
<h3 id="output">Output<a class="anchor" aria-label="anchor" href="#output"></a>
</h3>
<p><strong>nodes.csv</strong> - contains 3 columns: id, lon, lat with
respectively the OSM id of a node, its longitude and latitude.</p>
<table class="table">
<thead><tr class="header">
<th><strong>id</strong></th>
<th><strong>lon</strong></th>
<th><strong>lat</strong></th>
</tr></thead>
<tbody><tr class="odd">
<td><em>character</em></td>
<td><em>numeric</em></td>
<td><em>numeric</em></td>
</tr></tbody>
</table>
<p><strong>road_segments.csv</strong> - contains at least 3 columns, but
can contain more. The minimum expected columns are from, to, length. The
first 2 columns contain node ids.</p>
<table class="table">
<thead><tr class="header">
<th><strong>from</strong></th>
<th><strong>to</strong></th>
<th><strong>length</strong></th>
<th><strong>highway</strong></th>
</tr></thead>
<tbody><tr class="odd">
<td><em>character</em></td>
<td><em>character</em></td>
<td><em>numeric</em></td>
<td><em>character (factor)</em></td>
</tr></tbody>
</table>
<p>In some cases, node ids can be cast to long integers, but this is not
recommended.</p>
</div>
<div class="section level3">
<h3 id="example-workflow">Example workflow<a class="anchor" aria-label="anchor" href="#example-workflow"></a>
</h3>
<p>Once the package and dependencies are installed, the workflow is the
following:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/ischlo/cppRosm" class="external-link">cppRosm</a></span><span class="op">)</span></span>
<span><span class="co">## basic example code</span></span>
<span></span>
<span><span class="va">file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span>package <span class="op">=</span> <span class="st">'cppRosm'</span>,<span class="st">'extdata'</span>,<span class="st">"monaco-latest.osm.pbf"</span><span class="op">)</span> <span class="co"># path to a local file </span></span>
<span></span>
<span><span class="fu">cppRosm</span><span class="fu">::</span><span class="fu"><a href="../reference/extract_graph.html">extract_graph</a></span><span class="op">(</span><span class="va">file</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #00BBBB;">ℹ</span> Files will be written to:</span></span></code></pre>
<pre><code><span><span class="co">## [1] 1</span></span></code></pre>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># .... </span></span>
<span></span>
<span><span class="va">nodes</span> <span class="op">&lt;-</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/data.table/man/fread.html" class="external-link">fread</a></span><span class="op">(</span><span class="st">'nodes.csv'</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning in require_bit64_if_needed(ans): Some columns are type 'integer64' but</span></span>
<span><span class="co">## package bit64 is not installed. Those columns will print as strange looking</span></span>
<span><span class="co">## floating point data. There is no need to reload the data. Simply</span></span>
<span><span class="co">## install.packages('bit64') to obtain the integer64 print method and print the</span></span>
<span><span class="co">## data again.</span></span></code></pre>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">segments</span> <span class="op">&lt;-</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/data.table/man/fread.html" class="external-link">fread</a></span><span class="op">(</span><span class="st">'road_segments.csv'</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning in require_bit64_if_needed(ans): Some columns are type 'integer64' but</span></span>
<span><span class="co">## package bit64 is not installed. Those columns will print as strange looking</span></span>
<span><span class="co">## floating point data. There is no need to reload the data. Simply</span></span>
<span><span class="co">## install.packages('bit64') to obtain the integer64 print method and print the</span></span>
<span><span class="co">## data again.</span></span></code></pre>
<table class="table kable_wrapper"><tbody><tr>
<td>
<table class="table">
<caption>Nodes</caption>
<thead><tr class="header">
<th align="right">id</th>
<th align="right">lon</th>
<th align="right">lat</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">1.082601e-316</td>
<td align="right">7.426</td>
<td align="right">43.739</td>
</tr>
<tr class="even">
<td align="right">3.589763e-314</td>
<td align="right">7.426</td>
<td align="right">43.739</td>
</tr>
<tr class="odd">
<td align="right">5.334677e-315</td>
<td align="right">7.426</td>
<td align="right">43.739</td>
</tr>
<tr class="even">
<td align="right">1.039906e-314</td>
<td align="right">7.426</td>
<td align="right">43.739</td>
</tr>
<tr class="odd">
<td align="right">3.132851e-314</td>
<td align="right">7.426</td>
<td align="right">43.739</td>
</tr>
<tr class="even">
<td align="right">5.486898e-315</td>
<td align="right">7.426</td>
<td align="right">43.739</td>
</tr>
</tbody>
</table>
</td>
<td>
<table class="table">
<caption>Segments</caption>
<thead><tr class="header">
<th align="right">from</th>
<th align="right">to</th>
<th align="right">length</th>
<th align="left">highway</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">1.082601e-316</td>
<td align="right">3.589763e-314</td>
<td align="right">17.1</td>
<td align="left">secondary</td>
</tr>
<tr class="even">
<td align="right">3.589763e-314</td>
<td align="right">5.334677e-315</td>
<td align="right">5.5</td>
<td align="left">secondary</td>
</tr>
<tr class="odd">
<td align="right">5.334677e-315</td>
<td align="right">1.039906e-314</td>
<td align="right">3.1</td>
<td align="left">secondary</td>
</tr>
<tr class="even">
<td align="right">1.039906e-314</td>
<td align="right">3.132851e-314</td>
<td align="right">5.2</td>
<td align="left">secondary</td>
</tr>
<tr class="odd">
<td align="right">3.132851e-314</td>
<td align="right">5.486898e-315</td>
<td align="right">4.9</td>
<td align="left">secondary</td>
</tr>
<tr class="even">
<td align="right">5.486898e-315</td>
<td align="right">1.082601e-316</td>
<td align="right">6.9</td>
<td align="left">secondary</td>
</tr>
</tbody>
</table>
</td>
</tr></tbody></table>
<p>At the end of the execution of this code, you should find the two
files in your working directory (if you don’t know which one is it, run
<code><a href="https://rdrr.io/r/base/getwd.html" class="external-link">getwd()</a></code>).</p>
</div>
<div class="section level3">
<h3 id="exceptions">Exceptions<a class="anchor" aria-label="anchor" href="#exceptions"></a>
</h3>
<p>This package does not qualify for CRAN due to the fact that the low
level code writes into the files mentioned above. The CRAN specs do not
recommend this kind of actions because failure at the low level
execution crashes the R session resulting in potential loss of unsaved
data. However, due to the performance gain that executing at the low
level provides, it seemed worth the risk.</p>
<div class="section level4">
<h4 id="source-of-failure">Source of failure<a class="anchor" aria-label="anchor" href="#source-of-failure"></a>
</h4>
<p>The main source of failure of the low level code is the presence of
incomplete ways in the data. To avoid that, make sure to include
complete ways whenevver possible, and avoid using sources that do not
mention this specification about their data. The usual exporting tools
such as the OSM website, GEOFABRICK use the full data with complete
ways. When using command line tools, such as libosmium or osmosis, this
parameter is generally available. The recommended tool to use, is
filtering a wider area with the <code>rosmium</code> package in the
following way:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">rosmium</span><span class="fu">::</span><span class="fu">extract</span><span class="op">(</span></span>
<span>  input_path <span class="op">=</span> <span class="st">".../monaco-latest.osm.pbf"</span></span>
<span>  ,extent <span class="op">=</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_bbox.html" class="external-link">st_bbox</a></span><span class="op">(</span><span class="op">)</span> <span class="co"># a bbox</span></span>
<span>  ,output_path <span class="op">=</span> <span class="st">".../smaller_map.osm"</span></span>
<span>  ,strategy <span class="op">=</span> <span class="st">"complete_ways"</span> <span class="co"># !!! important</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>The parameter <code>strategy="complete_ways"</code> ensures that ways
are exported without missing bits.</p>
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Ivann Schlosser.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
